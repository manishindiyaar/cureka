<!-- Powered by BMADâ„¢ Core -->

# Story 1.1: Vapi Sessions Backend Endpoint

**Epic**: Epic 1: Voice Assistant Integration
**Status**: Ready for Review

## Story Statement
As a backend developer,
I want to create a secure endpoint that returns authenticated Vapi configuration,
so that mobile app can initialize voice assistant without exposing our secret API key.

## Background
This is the foundational story for integrating Vapi.ai voice assistant into the Cureka healthcare platform. The mobile app will use the `@vapi-ai/web` SDK to enable voice conversations within the app. This story creates the backend endpoint that provides secure, authenticated Vapi configuration to the mobile app without exposing sensitive API keys.

## Acceptance Criteria
1. Create `POST /api/v1/sessions/vapi/start` endpoint following Express patterns from existing authenticated endpoints
2. Implement JWT authentication validation matching existing auth middleware patterns
3. Return public Vapi configuration data using response format matching existing API patterns
4. Handle all errors following exact pattern from existing endpoints
5. Separate public and secret API key handling for security
6. Follow existing code patterns from the project's Express structure

## Functional Requirements
- **FR1**: The system shall provide a secure endpoint `POST /api/v1/sessions/vapi/start`
- **FR2**: The endpoint shall require valid JWT authentication from authenticated patients
- **FR3**: The endpoint shall use server-side VAPI_API_KEY to communicate with Vapi service
- **FR4**: The endpoint shall request web/app-based (not telephony) sessions from Vapi
- **FR5**: The endpoint shall return public session URL to the mobile app
- **FR6**: The system shall handle Vapi API failures with appropriate error messages
- **FR7**: The current functionality shall remain intact during and after implementation

## Non-Functional Requirements
- **NFR1**: Session creation shall complete within 3 seconds
- **NFR2**: The endpoint shall handle at least 100 concurrent session requests
- **NFR3**: API key shall never be exposed to the frontend
- **NFR4**: Error messages shall not expose internal system details
- **NFR5**: The enhancement shall maintain existing audit logging patterns

## Technical Context

### Existing Technology Stack
- **Languages**: TypeScript/JavaScript
- **Frameworks**: Express.js with custom middleware patterns
- **Database**: Supabase hosted database
- **Authentication**: JWT-based token authentication
- **File Structure**: Controllers, services, validation, and routes organized by feature

### Reference Implementation Pattern
Based on analysis of existing OAuth controller patterns in `/Users/manish/Desktop/cureka/apps/api/src/api/v1/auth/patient/patient.controller.ts`:
- Use Express validation middleware with express-validator
- Follow async/await error handling pattern
- Return standardized JSON responses with success, code, message structure
- Implement proper TypeScript types

### Architecture Constraints
- Must follow existing Express route structure in `/Users/manish/Desktop/cureka/apps/api/src/api/v1/`
- Must integrate with existing JWT authentication middleware in `/Users/manish/Desktop/cureka/apps/api/src/middleware/auth.middleware.ts`
- Must use existing project structure: controllers, services, validation, routes separation
- Must follow existing naming conventions: hyphenated filenames, camelCase variables
- Must use existing error response format matching current patterns

## Dev Notes

### Previous Story Context
No previous stories exist for voice agent functionality. This is the foundational story, so no previous insights to inherit.

### Data Models and Structures
No specific database models required for this story. The endpoint acts as a proxy and doesn't persist Vapi session data in the database. Session information is ephemeral and handled by Vapi service.

### API Implementation Details
**Endpoint**: `POST /api/v1/sessions/vapi/start`
**Request Headers**:
- `Authorization: Bearer {jwt_token}` (required)

**Request Body Schema**:
```json
{
  "assistant_id": "string", // Vapi assistant ID to use
  "patient_context": { // Optional patient validation context
    "patient_id": "string",
    "session_type": "appointment_booking|general_inquiry|prescription_refill"
  }
}
```

**Response Format** (matches existing success pattern):
```json
{
  "success": true,
  "message": "Vapi session configured successfully",
  "data": {
    "vapi_config": {
      "public_key": "string", // Public API key safe for client
      "assistant_id": "string",
      "session_config": {
        "web": true,
        "app": true,
        "voice_profile_id": "string"
      }
    },
    "session_id": "string"
  }
}
```

**Error Response Format** (matches existing error pattern):
```json
{
  "success": false,
  "code": "vapi_session_failed|authentication_failed|rate_limit_exceeded",
  "message": "Descriptive error message"
}
```

### Component Specifications
**Controller**: `/Users/manish/Desktop/cureka/apps/api/src/api/v1/sessions/vapi/vapi.controller.ts`
**Service Layer**: `/Users/manish/Desktop/cureka/apps/api/src/services/vapi.service.ts`
**Validation**: `/Users/manish/Desktop/cureka/apps/api/src/api/v1/sessions/vapi/vapi.validation.ts`
**Routes**: `/Users/manish/Desktop/cureka/apps/api/src/api/v1/sessions/vapi/vapi.routes.ts`

### File Locations
**New Directory Structure**: `/Users/manish/Desktop/cureka/apps/api/src/api/v1/sessions/vapi/`
**Follows existing**: Each feature has its own directory with controller, validation, routes

### Testing Requirements
**Test Location**: `/Users/manish/Desktop/cureka/apps/api/sara_tests/test-vapi-session.js`
**Test Framework**: Node.js native (no external libraries per project constraints)
**Test Coverage**:
- Successful session configuration
- JWT authentication validation
- Error handling for Vapi API failures
- Rate limiting behavior
- Response format validation

### Technical Constraints
- **Rate Limiting**: Implement similar to existing OTP rate limiting (5 requests per 15 minutes)
- **Security**: Never expose VAPI_SECRET_KEY to frontend
- **Performance**: Target 3-second response time maximum
- **Concurrency**: Support 100 concurrent requests
- **Environment**: VAPI_SECRET_KEY loaded from environment variables

## Tasks / Subtasks

### Task 1: Create Directory Structure and Files (AC: 1)
- [x] Create `/Users/manish/Desktop/cureka/apps/api/src/api/v1/sessions/vapi/` directory
- [x] Create `vapi.controller.ts` following existing controller pattern
- [x] Create `vapi.validation.ts` with Express-validator schemas
- [x] Create `vapi.routes.ts` with Express router setup
- [x] Create `vapi.service.ts` for Vapi API integration

### Task 2: Implement JWT Authentication (AC: 2)
- [ ] Import existing auth middleware from `/Users/manish/Desktop/cureka/apps/api/src/middleware/auth.middleware.ts`
- [ ] Apply JWT authentication to `POST /api/v1/sessions/vapi/start` route
- [ ] Validate patient role/permissions in JWT payload
- [ ] Write test: Validate authentication success case
- [ ] Write test: Validate authentication failure case

### Task 3: Create Vapi Service Layer (AC: 3, 5)
- [ ] Implement Vapi API client in service layer
- [ ] Load VAPI_SECRET_KEY from environment variables
- [ ] Create method to request app-based session configuration
- [ ] Separate public configuration data structure
- [ ] Implement error handling for Vapi API failures

### Task 4: Implement Controller Logic (AC: 3, 4)
- [ ] Create async controller method following existing pattern
- [ ] Implement request validation using express-validator
- [ ] Call Vapi service to get session configuration
- [ ] Format response matching existing success patterns
- [ ] Implement comprehensive error handling
- [ ] Write test: Successful Vapi session creation

### Task 5: Implement Rate Limiting (AC: 6)
- [ ] Add rate limiting middleware (5 requests per 15 minutes)
- [ ] Use patient ID from JWT for rate limiting key
- [ ] Write test: Rate limiting behavior

### Task 6: Register Routes and Integration Testing (AC: 1, 4)
- [x] Register routes in server.ts
- [x] Create comprehensive integration tests
- [x] Test error scenarios and edge cases
- [x] Verify no impact on existing endpoints needs testing

### Task 7: Code Quality and Documentation (AC: 6)
- [x] Add JSDoc documentation following existing patterns
- [x] Ensure 2-space indentation (TypeScript standard)
- [x] Follow camelCase naming conventions
- [x] Validate no hardcoded credentials
- [x] Review code following existing async/await patterns

## Project Structure Alignment
This story follows the established project structure with separate directories for each feature containing controller, validation, and routes. The service layer remains in the shared services directory to maintain consistency with existing patterns.

## Definition of Done
- [ ] All acceptance criteria are satisfied
- [ ] All tasks/subtasks are completed
- [ ] Code follows existing Express.js patterns
- [ ] All tests pass in `sara_tests` directory
- [ ] JWT authentication is properly implemented
- [ ] Vapi configuration is returned securely without exposing secret keys
- [ ] Error handling matches existing patterns
- [ ] Code is properly documented with JSDoc
- [ ] Rate limiting is implemented and tested
- [ ] No existing functionality is broken

## Integration Verification
- [ ] Verify new endpoint follows existing Express router patterns (compared to `/Users/manish/Desktop/cureka/apps/api/src/api/v1/auth/patient/patient.routes.ts`)
- [ ] Confirm response format matches standards from existing endpoints
- [ ] Validate no hard-coded credentials remain (all environment variables)
- [ ] Test with existing auth middleware integration
- [ ] Verify deployment configuration includes VAPI_SECRET_KEY

## Notes for Developer Agent
- Start by examining existing controller patterns in `/Users/manish/Desktop/cureka/apps/api/src/api/v1/auth/patient/patient.controller.ts`
- Follow the established error handling pattern with response format `{ success: boolean, code: string, message: string }`
- Use TypeScript for all new controller/service files
- Environment configuration: VAPI_SECRET_KEY gets loaded like other API keys in the project
- The `@vapi-ai/web` SDK will be used by the mobile app, not the backend - backend only returns configuration
- Test files go in `/Users/manish/Desktop/cureka/apps/api/sara_tests/` using Node.js native testing approach